name: BTC Price Alert

on:
  schedule:
    # Every day at 9:00 AM Beijing time (UTC+8) = 1:00 AM UTC
    - cron: '0 1 * * *'
    # Every 3 hours
    - cron: '0 */3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-price:
    runs-on: ubuntu-latest
    steps:
      - name: Check BTC Price and Alert
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          RESPONSE=$(curl -s 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')
          PRICE=$(echo "$RESPONSE" | jq -r '.bitcoin.usd')

          if [ -z "$PRICE" ] || [ "$PRICE" = "null" ]; then
            echo "Failed to fetch BTC price"
            exit 1
          fi

          echo "Current BTC price: \$$PRICE"

          # Check which cron triggered this run
          # Daily 9AM Beijing (1AM UTC): always send price
          HOUR_UTC=$(date -u +%H)
          MINUTE_UTC=$(date -u +%M)

          IS_DAILY="false"
          # GitHub Actions cron can be delayed up to 1 hour, so check 01:00-01:59 UTC
          if [ "$HOUR_UTC" = "01" ]; then
            IS_DAILY="true"
          fi

          # For manual trigger, treat as daily report
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IS_DAILY="true"
          fi

          SEND="false"
          TITLE=""
          BODY=""

          if [ "$IS_DAILY" = "true" ]; then
            SEND="true"
            TITLE="BTC 早报"
            BODY="当前 BTC 价格: \$${PRICE}"
          fi

          # Every 3 hours: alert if price < 60000
          if [ "$(echo "$PRICE < 60000" | bc -l)" -eq 1 ]; then
            SEND="true"
            TITLE="BTC 价格预警"
            BODY="BTC 当前价格 \$${PRICE}，已跌破 \$60,000"
          fi

          if [ "$SEND" = "true" ]; then
            echo "Sending notification: $TITLE - $BODY"
            ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${TITLE}'))")
            ENCODED_BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${BODY}'))")
            curl -s "https://api.day.app/${BARK_KEY}/${ENCODED_TITLE}/${ENCODED_BODY}?group=btc-price"
            echo ""
            echo "Bark notification sent!"
          else
            echo "No alert needed. Price \$$PRICE is above \$70,000."
          fi
